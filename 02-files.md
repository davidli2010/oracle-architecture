# 文件

与实例相关的文件有以下几种：
- 参数文件
- 跟踪文件
- 警告文件
- 数据文件
- 临时文件
- 控制文件
- 重做日志文件
- 密码文件

从Oracle10g开始，增加了两种新的可选文件：
- 修改跟踪文件
- 闪回日志文件

与数据库有关的其他类型的文件：
- 转储文件
- 数据泵文件
- 平面文件

## 参数文件

数据库的参数文件通常称为初始文件（init file），或init.ora文件。Oracle9i引入了一个有很大改进的新方法：服务器参数文件，简称为SPFILE。这个文件的默认名为spfile<ORACLE_SID>.ora。

SPFILE消除了传统参数文件存在的两个严重问题：
- 杜绝了参数文件的繁殖。SPFILE总是存储在数据库服务器上；它必须存在于服务器主机本身，不能放在客户机上，这样就只有一个“正确的”参数“来源”。
- 无需（实际上是不能）在数据库之外使用文本编辑器手动地维护参数文件。必须利用ALTER SYSTEM命令才能将参数设置写入SPFILE。

## 跟踪文件

跟踪文件(trace file)能够提供调试信息。服务器遇到问题时，它会生成一个包含大量诊断信息的跟踪文件。如果开发人员执行了DBMS_MONITOR.SESSION_TRACE_ENABLE，服务器就会生成一个包含性能相关信息的跟踪文件。我们之所以可以使用这些跟踪文件，是因为Oracle是一个具有很高可测量性的软件。

Oracle数据库具有良好的可测试性，数据库中这种可测试行反映在以下几个方面：
- V$视图：大多数V$视图都包含“调试”信息。V$WAITSTAT、V$SESSION_EVENT还有其他许多V$视图能够让我们知道内核到底发生了什么。
- 审计(AUDIT)命令：利用这个命令，能指定数据库要记录哪些事件以便日后分析。
- 资源管理器(DBMS_RESOURCE_MANAGER)：这个特性允许对数据库所使用的资源（CPU、I/O等）进行更精细的管理。Oracle的资源管理器充分利用了内核中的可测量代码来了解数据库运行时各种资源的使用状况，这样它就有可能对这些资源的使用做进一步的控制。
- Oracle事件（event）：能让Oracle生成所需的跟踪或诊断信息。
- DBMS_TRACE：这是PL/SQL引擎中的一个工具，它会全面地记录存储过程的调用树、产生的异常以及遇到的错误。
- 数据库事件触发器：这些触发器允许你监控和记录你觉得意外或非正常的情况。
- SQL_TRACE/DBMS_MONITOR：这个工具用于查看数据库执行的SQL语句、等待事件以及其它性能/行为相关的诊断信息。

## 警告文件

警告文件（也称为警告日志）就是数据库的日志。这是一个简单的文本文件，数据库从创建那一天起就不停的写入该文件，直到数据库被删除为止。在这个文件中，可以看到数据库的“编年史”，比如说在线日志文件切换、内部错误、表空间的创建、离线以及恢复为在线等等。这是一个查看数据库历史的极其有用的文件。

## 数据文件

数据文件和重做日志文件是数据库中最重要的文件，数据最终会存储在这些文件中。每个数据库都至少有一个数据文件，通常还不止一个。

### Oracle数据库中的存储层次体系

数据库由一个或多个表空间构成。表空间（tablespace）是Oracle中的一个逻辑存储容器，位于存储层次体系的顶层，包括一个或多个数据文件。表空间包含段。

1. 段

段是表空间中的主要组织结构。段（segment）就是占用存储空间的数据库对象，如表、索引及回滚段等。在创建表时，会创建一个表段；在创建分区表时，创建的不是表的段，而是为每个分区创建一个段；当你创建索引时，就会创建一个索引段，依次类推。占用存储空间的每一个对象最后都会存储在一个段中。除了上面讲到的段，还有回滚段（rollback segment）、临时段（temporary segment）以及聚簇段（cluster segment）。

2. 区段

段本身又由一个或多个区段组成。区段（extent）是文件中一个逻辑上连续分配的空间。传统的每个段都至少有一个区段。当你创建对象时，Oracle不会立即为段分配一个新的区段，只有当数据真正写入到这个对象时，Oracle才会为这个段分配第一个区段。如果一个对象初始区段不足以容纳新增的数据，Oracle就会再为它分配另一个区段。区段内的空间总是文件中的一个逻辑连续空间。

3. 块

区段又进一步由块组成。块（block）是Oracle中最小的空间分配单位。行数据、索引条目或临时排序结果就存储在块中。通常Oracle从磁盘读写的就是块。Oracle中块的常见大小有4种：2KB、4KB、8KB或16KB。在表空间内部，所有的块大小都是一致的。

4. 表空间

段不会跨越表空间边界。表空间本身可以有一个或多个数据文件。一个区段仅会存放于一个数据文件中。不过，段可以有来自多个不同数据文件的区段。


5. 小结

（1）数据库由一个或多个表空间组成。  
（2）表空间由一个或多个数据文件组成。表空间包含段。  
（3)段由一个或多个区段组成。段不能跨表空间存放，但是段中的数据可以跨文件存放。  
（4）区段是磁盘上一组逻辑连续的块。区段只能在一个表空间中，而且总是在该表空间的一个文件中。  
（5）块石数据库中最小的分配单位，也是数据库使用的最小I/O单位。

## 临时文件

Oracle中的临时数据文件（temporary data file）是一种特殊类型的数据文件。当内存不足时，Oracle会使用它来存储一些临时数据，比如说一些比较大的排序或散列操作的中间结果、临时表中的数据以及结果集数据等。

对临时文件内的数据的修改不会生成重做日志，但会生成undo日志。如果你回滚了事务，或者你的会话发生了某些错误，这时为全局临时表生成的undo就可以用来取消你所作的修改。

如果操作系统允许创建的话，临时表空间的文件则会以稀疏（sparse）的方式创建，也就是说，这样的文件会“按需”占用磁盘的空间。

## 控制文件

控制文件（control file）是一个相当小的文件，它储存了数据库需要的一些文件的位置。数据库启动时，实例会从参数文件中知道控制文件的位置，而通过控制文件则会知道数据库的数据文件和在线重做日志文件的位置。

控制文件还记录了Oracle的其他一些信息，如检查点（checkpoint）的有关信息、数据库名、数据库创建的时间戳、归档重做日志的历史以及RMAN信息等。

## 重做日志文件

重做日志文件（redo log file）对于Oracle数据库至关重要，它是数据库的事务日志。通常情况下重做日志是用于恢复的，但也可以用于：
- 系统崩溃后的实例恢复；
- 从备份复原出来的数据文件的介质恢复；
- 备用（standby）数据库处理；
- Streams和Golden Gate，这两个工具可以对重做日志进行挖掘，从而实现信息共享；
- 让管理员能够通过Oracle LogMiner功能查看数据库的历史事务。

重做日志文件的主要目的是，当实例或存储介质出问题时，它就能派上用场。它也可以用于维护备用数据库从而实现故障时的切换。如果数据库主机掉电，导致实例失败，Oracle会使用在线重做日志将系统恢复到掉电前的那个状态。如果数据文件所在磁盘驱动器出现了故障，Oracle可以使用归档重做日志、在线重做日志、以及数据库的备份将涉及的文件恢复到适当的时间点上。

你在Oracle中完成的几乎所有操作都会生成redo，并写入到在线重做日志文件中。当你向表中插入一行时，这一行也会写入到重做日志中去；当你删除一行时，则会在重做日志中记下“删除”这个消息；当你删除一个表时，这个动作本身也会写入重做日志。当你删除表时，表中的数据不会记到重做日志中，但删除表这个动作本身会执行一些递归的SQL，这些递归SQL会产生redo。

### 在线重做日志

每个Oracle数据库都至少有两个在线重做日志文件组，每个重做日志组都包含一个或多个重做日志成员。在同一个组内的重做日志文件是完全一样的镜像。这些在线重做日志文件的大小是固定的，并以循环方式使用。

从一个日志文件组切换到另一个日志文件组的动作称为日志切换（log switch）。由于重做日志最重要的目标是在实例失败后能够恢复已提交的事务，所以必须要保证日志切换时所覆盖的重做日志中的内容不能包含实例恢复需要的数据。

## 密码文件

密码文件（password file）不是数据库运行时必须要有的文件，它用于远程SYSDBA或管理员来访问数据库。

## 修改跟踪文件

修改跟踪文件（change-tracking file）也不是数据库运行时必须要有的文件。Oracle会在这个文件中记录自上一个增量备份以来哪些块已被修改。RMAN会使用这个文件来备份那些有变化的数据块，而不必读取整个数据库。

## 闪回日志

闪回日志（flashback log）是Oracle10g为支持FLASHBACK DATABASE命令而引入的。闪回日志包含数据块“被修改之前的映像”，它可用于将数据库返回到之前某个时间点的状态。

## DMP文件

导出（Export）和导入（Import）工具是Oracle的数据提取和加载工具。可以使用Export来创建一个平台独立的DMP文件，这个文件中会包含所有导出对象相关的元数据以及数据本身，由此我们可以重建表、模式甚至整个数据库。导入工具的唯一作用就是读取这些DMP文件、执行其DDL语句、并加载它找到的所有数据。

## 数据泵文件

Oracle数据库有两个工具使用数据泵（data pump）文件格式：外部表（external table）可以加载和卸载数据泵格式的数据，新的导入/导出工具IMPDP和EXPDP使用这种文件格式的方式与IMP和EXP使用DMP文件格式的方式完全一样。
数据泵文件中的元数据以XML方式来存储。IMPDP和EXPDP有一些巧妙的过滤和转换功能。

## 平面文件

自从有了电子数据处理，就有了平面文件（flat file）。

>平面文件是去除了所有特定应用（程序）格式的电子记录，从而使数据元素可以迁移到其他的应用上进行处理。这种去除电子数据格式的方式可以避免因为硬件和专有软件的过时而导致的数据丢失。

实际上，平面文件就是一个每一“行”都是一条“记录”的简单文件，在每行之间都有一些定界的符号，通常用逗号或管道符号（竖线）分隔。
